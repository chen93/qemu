CORE_OBJ = csi.core.elf
BOARD_DIR = ../board/smartl/ck803s
CFLAGS = -g2 -mcpu=ck803s -Wa,-mcpu=803sef -Wa,-medsp -msoft-float
TARGET_CROSS = csky-abiv2-elf

CC = $(TARGET_CROSS)-gcc

ROOTDIR = $(shell pwd)/
srcdir = $(ROOTDIR)../
EXPECT = expect
RUNTEST = runtest
RUNTESTFLAGS =

all: core

core:
	@echo "  CC    $(BOARD_DIR)/crt0.o"
	@$(CC) -c $(CFLAGS) $(BOARD_DIR)/crt0.S -o $(BOARD_DIR)/crt0.o
	@echo "  CC    $(BOARD_DIR)/uart.o"
	@$(CC) -c $(CFLAGS) $(BOARD_DIR)/uart.c -o $(BOARD_DIR)/uart.o
	make -C case

clean:
	rm -f $(BOARD_DIR)/*.o
	rm -f site.exp
	rm -rf testresult
	make -C case clean


site.exp:
	@echo 'Making a new site.exp file...'
	@echo '## these variables are automatically generated by make ##' >site.tmp
	@echo '# Do not edit here.  If you wish to override these values' >>site.tmp
	@echo '# edit the last section' >>site.tmp
	@echo "set rootme $(srcdir)" >>site.tmp
	@echo 'set srcdir $(srcdir)' >>site.tmp
	@echo "set objdir `pwd`/testresult/" >>site.tmp
	@echo "set tmpdir `pwd`/testresult/" >>site.tmp
	@echo "set CFLAGS \"$(CFLAGSDEJA) $(INCLUDEDIRS) -L$(srcdir)lib/  -L$(srcdir)tests/arch  -lc -lgcc  \"" >> site.tmp
	@echo "set host_triplet x86_64-pc-linux-gnu" >> site.tmp
	@echo "set build_triplet x86_64-pc-linux-gnu" >> site.tmp
	@echo "set target_triplet csky-unknown-elf">> site.tmp
	@echo "set target_alias $(TARGET_CROSS)" >> site.tmp
	@echo "set HOSTCC gcc" >> site.tmp
	@echo "set tool csi" >> site.tmp
	@echo '## All variables above are generated by configure. Do Not Edit ##' >>site.tmp
	@test ! -f site.exp || \
	  sed '1,/^## All variables above are.*##/ d' site.exp >> site.tmp
	@-rm -f site.bak
	@test ! -f site.exp || mv site.exp site.bak
	@mv site.tmp site.exp

check:site.exp
	if [ -d testresult/ ]; then \
	  true; \
	else \
	  mkdir testresult/; \
	fi
	echo "cflag ${CFLAGS}"
	rm -f testresult/*
	cp site.exp testresult/site.exp
	rootme=`pwd`/testresult; export rootme; \
	srcdir=`cd ${srcdir}/; pwd` ; export srcdir ; \
	EXPECT=${EXPECT} ; export EXPECT ; \
	runtest=$(RUNTEST); \
	cd testresult; \
	if $(SHELL) -c "$$runtest --version" > /dev/null 2>&1; then \
	   $$runtest --srcdir $${srcdir}/testsuite \
	   $(RUNTESTFLAGS); \
	else  echo "WARNING: could not find \`runtest'" 1>&2; :;\
	fi
